{
    "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "topLevelManagementGroupPrefix": {
            "type": "string",
            "metadata": {
                "description": "Provide a prefix (max 10 characters, unique at tenant-scope) for the Management Group hierarchy and other resources created as part of Enterprise-scale."
            }
        },
		"identitySubscriptionId": {
			"type": "string"
		},
        "identitySubnetDevName": {
			"type": "string"
		},
		"identitySubnetUatName": {
			"type": "string"
		},
		"identitySubnetProdName": {
			"type": "string"
		},
        "identitySubnetDevPrefix": {
			"type": "string"
		},
		"identitySubnetUatPrefix": {
			"type": "string"
		},
		"identitySubnetProdPrefix": {
			"type": "string"
		},
        "devIdentityNsgName": {
			"type": "string"
		},
		"uatIdentityNsgName": {
			"type": "string"
		},
		"prodIdentityNsgName": {
			"type": "string"
		},
        "primaryregioncode": {
			"type": "string"
		},
		"secondaryregioncode": {
			"type": "string"
		},
		"identityVnetName": {
			"type": "string"		
		},
		"identityVnetPrefix": {
		    "type": "string"
		},
		"adProdAvailabilitySetName": {
			"type": "string"
		},
        "networkInterfaceName": {
			"type": "string"
		},
		"DNSServerAddress": {
			"type": "string"
		},
		"virtualMachineName": {
			"type": "string"
		},
        "vmSize": {
			"type": "string"
		},
		"adminUsername": {
			"type": "string"
		},
		"adminPassword": {
			"type": "string"		
		},
		"domainName": {
		    "type": "string"
		}
    },
    "variables": {
		"nsgIdentityDeployment": "[concat('nsg-deployment-', parameters('identityVnetName'))]",
        "vnetIdentityDeployment": "[concat('vnet-deployment-', parameters('identityVnetName'))]",
		"ADDeployment": "[concat('ad-deployment-', parameters('identityVnetName'))]",
        "rgNameIdentity": "[concat('rg', '-idy-', parameters('primaryregioncode'))]",
		"deploymentUris": {
			"adps": "[uri(deployment().properties.templateLink.uri, 'auxiliary/CreateADPDC.ps1')]",
			"adzip": "[uri(deployment().properties.templateLink.uri, 'auxiliary/CreateADPDC.zip')]"

		}
    },
    "resources": [
        {
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2019-10-01",
			"name": "[variables('nsgIdentityDeployment')]",
			"subscriptionId": "[parameters('identitySubscriptionId')]",
			"resourceGroup": "[variables('rgNameIdentity')]",
			"properties": {
				"mode": "Incremental",
				"template": {
					"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
					"contentVersion": "1.0.0.0",
					"parameters": {},
					"resources": [{
							"type": "Microsoft.Network/networkSecurityGroups",
							"apiVersion": "2020-05-01",
							"name": "[parameters('devIdentityNsgName')]",
							"location": "[deployment().location]",
							"properties": {
								"securityRules": [{
									"name": "default-allow-3389",
									"properties": {
										"priority": 1000,
										"access": "Allow",
										"direction": "Inbound",
										"destinationPortRange": "3389",
										"protocol": "Tcp",
										"sourceAddressPrefix": "*",
										"sourcePortRange": "*",
										"destinationAddressPrefix": "*"
									}
								}]
							}
						},
                        {
							"type": "Microsoft.Network/networkSecurityGroups",
							"apiVersion": "2020-05-01",
							"name": "[parameters('uatIdentityNsgName')]",
							"location": "[deployment().location]",
							"properties": {
								"securityRules": [{
									"name": "default-allow-3389",
									"properties": {
										"priority": 1000,
										"access": "Allow",
										"direction": "Inbound",
										"destinationPortRange": "3389",
										"protocol": "Tcp",
										"sourceAddressPrefix": "*",
										"sourcePortRange": "*",
										"destinationAddressPrefix": "*"
									}
								}]
							}
						},
                        {
							"type": "Microsoft.Network/networkSecurityGroups",
							"apiVersion": "2020-05-01",
							"name": "[parameters('prodIdentityNsgName')]",
							"location": "[deployment().location]",
							"properties": {
								"securityRules": [{
									"name": "default-allow-3389",
									"properties": {
										"priority": 1000,
										"access": "Allow",
										"direction": "Inbound",
										"destinationPortRange": "3389",
										"protocol": "Tcp",
										"sourceAddressPrefix": "*",
										"sourcePortRange": "*",
										"destinationAddressPrefix": "*"
									}
								}]
							}
						}


					]
				}
			}
		},
        {
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2019-10-01",
			"name": "[variables('vnetIdentityDeployment')]",
			"resourceGroup": "[variables('rgNameIdentity')]",
			"dependsOn": [
				"[variables('nsgIdentityDeployment')]"
			],
			"subscriptionId": "[parameters('identitySubscriptionId')]",
			"properties": {
				"mode": "Incremental",
				"template": {
					"$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
					"contentVersion": "1.0.0.0",
					"parameters": {},
					"resources": [{
							"type": "Microsoft.Network/virtualNetworks",
							"apiVersion": "2020-05-01",
							"name": "[parameters('identityVnetName')]",
							"location": "[deployment().location]",
							"properties": {
								"addressSpace": {
									"addressPrefixes": [
										"[parameters('identityVnetPrefix')]"
									]
								},
								"subnets": [{
										"name": "[parameters('identitySubnetProdName')]",
										"properties": {
											"addressPrefix": "[parameters('identitySubnetProdPrefix')]",
											"networkSecurityGroup": {
												"id": "[concat('/subscriptions/', parameters('identitySubscriptionId'), '/resourceGroups/', variables('rgNameIdentity'), '/providers/Microsoft.Network/networkSecurityGroups/', parameters('prodIdentityNsgName'))]"
											}

										}
									},
									{
										"name": "[parameters('identitySubnetUatName')]",
										"properties": {
											"addressPrefix": "[parameters('identitySubnetUatPrefix')]",
                                            "networkSecurityGroup": {
												"id": "[concat('/subscriptions/', parameters('identitySubscriptionId'), '/resourceGroups/', variables('rgNameIdentity'), '/providers/Microsoft.Network/networkSecurityGroups/', parameters('uatIdentityNsgName'))]"
											}

										}
									},
									{
										"name": "[parameters('identitySubnetDevName')]",
										"properties": {
											"addressPrefix": "[parameters('identitySubnetDevPrefix')]",
                                            "networkSecurityGroup": {
												"id": "[concat('/subscriptions/', parameters('identitySubscriptionId'), '/resourceGroups/', variables('rgNameIdentity'), '/providers/Microsoft.Network/networkSecurityGroups/', parameters('devIdentityNsgName'))]"
											}



										}
									}
								]
							}
						}


					]
				}
			}
		},
		{
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2019-10-01",
			"name": "[variables('ADDeployment')]",
			"subscriptionId": "[parameters('identitySubscriptionId')]",
			"resourceGroup": "[variables('rgNameIdentity')]",
			"dependsOn": [
				"identityvnetdeployment"
			],
			"properties": {
				"mode": "Incremental",
				"template": {
					"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
					"contentVersion": "1.0.0.0",
					"parameters": {},
					"resources": [{
							"type": "Microsoft.Compute/availabilitySets",
							"apiVersion": "2019-03-01",
							"location": "[deployment().location]",
							"name": "[parameters('adProdAvailabilitySetName')]",
							"properties": {
								"PlatformUpdateDomainCount": 20,
								"PlatformFaultDomainCount": 2
							},
							"sku": {
								"name": "Aligned"
							}
						},
						{
							"type": "Microsoft.Network/networkInterfaces",
							"apiVersion": "2019-02-01",
							"name": "[parameters('networkInterfaceName')]",
							"location": "[deployment().location]",
							"dependsOn": [
								"[parameters('adProdAvailabilitySetName')]"
							],
							"properties": {
								"ipConfigurations": [{
									"name": "ipconfig1",
									"properties": {
										"privateIPAllocationMethod": "Static",
										"privateIPAddress": "[parameters('DNSServerAddress')]",
										"subnet": {

											"id": "[concat('/subscriptions/', parameters('identitySubscriptionId'), '/resourceGroups/', variables('rgNameIdentity'), '/providers/Microsoft.Network/virtualNetworks/', parameters('identityVnetName'), '/subnets/', parameters('identitySubnetProdName'))]"
										}
									}
								}]
							}
						},
						{
							"type": "Microsoft.Compute/virtualMachines",
							"apiVersion": "2019-03-01",
							"name": "[parameters('virtualMachineName')]",
							"location": "[deployment().location]",
							"dependsOn": [
								"[parameters('networkInterfaceName')]",
								"[parameters('adProdAvailabilitySetName')]"
							],
							"properties": {
								"hardwareProfile": {
									"vmSize": "[parameters('vmSize')]"
								},
								"availabilitySet": {

									"id": "[concat('/subscriptions/', parameters('identitySubscriptionId'), '/resourceGroups/', variables('rgNameIdentity'), '/providers/Microsoft.Compute/availabilitySets/', parameters('adProdAvailabilitySetName'))]"

								},
								"osProfile": {
									"computerName": "[parameters('virtualMachineName')]",
									"adminUsername": "[parameters('adminUsername')]",
									"adminPassword": "[parameters('adminPassword')]"
								},
								"storageProfile": {
									"imageReference": {
										"publisher": "MicrosoftWindowsServer",
										"offer": "WindowsServer",
										"sku": "2019-Datacenter",
										"version": "latest"
									},
									"osDisk": {
										"name": "[concat(parameters('virtualMachineName'),'_OSDisk')]",
										"caching": "ReadOnly",
										"createOption": "FromImage",
										"managedDisk": {
											"storageAccountType": "StandardSSD_LRS"
										}
									},
									"dataDisks": [{
										"name": "[concat(parameters('virtualMachineName'), '_DataDisk')]",
										"caching": "None",
										"createOption": "Empty",
										"diskSizeGB": 20,
										"managedDisk": {
											"storageAccountType": "StandardSSD_LRS"
										},
										"lun": 0
									}]
								},
								"networkProfile": {
									"networkInterfaces": [{

										"id": "[concat('/subscriptions/', parameters('identitySubscriptionId'), '/resourceGroups/', variables('rgNameIdentity'), '/providers/Microsoft.Network/networkInterfaces/', parameters('networkInterfaceName'))]"

									}]
								}
							},
							"resources": [{
								"type": "extensions",
								"apiVersion": "2019-03-01",
								"name": "CreateADForest",
								"location": "[deployment().location]",
								"dependsOn": [
									"[parameters('virtualMachineName')]"
								],
								"properties": {
									"publisher": "Microsoft.Powershell",
									"type": "DSC",
									"typeHandlerVersion": "2.19",
									"autoUpgradeMinorVersion": true,
									"settings": {
										"ModulesUrl": "[variables('deploymentUris').adzip]",
										"ConfigurationFunction": "CreateADPDC.ps1\\CreateADPDC",
										"Properties": {
											"DomainName": "[parameters('domainName')]",
											"AdminCreds": {
												"UserName": "[parameters('adminUsername')]",
												"Password": "PrivateSettingsRef:AdminPassword"
											}
										}
									},
									"protectedSettings": {
										"Items": {
											"AdminPassword": "[parameters('adminPassword')]"
										}
									}
								}
							}]
						}
						
							
								


					]
				}
			}
		}
    ],
    "outputs": {}
}
